# Архитектура чат-рулетки Swirl - Итоговая схема

## Реализованная архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                    CLIENT (Flutter)                             │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              ChatRouletteScreen                             │ │
│  │                                                             │ │
│  │  • UI для поиска собеседника                               │ │
│  │  • Skeleton loading анимации                               │ │
│  │  • Кнопки управления чатом                                │ │
│  │  • Интеграция с ChatRouletteService                        │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              ChatRouletteService                           │ │
│  │                                                             │ │
│  │  • joinSearchQueue()                                       │ │
│  │  • leaveSearchQueue()                                      │ │
│  │  • watchUserStatus()                                       │ │
│  │  • watchMatch()                                            │ │
│  │  • sendTempMessage()                                       │ │
│  │  • saveChat() / deleteTempChat()                           │ │
│  │  • endMatch() / findNextPartner()                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FIREBASE BACKEND                            │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              REALTIME DATABASE                             │ │
│  │                                                             │ │
│  │  chat_roulette/                                            │ │
│  │  ├── queue/                                                │ │
│  │  │   └── {userId}/                                         │ │
│  │  │       ├── uid: string                                   │ │
│  │  │       ├── name: string                                  │ │
│  │  │       ├── age: number                                   │ │
│  │  │       ├── gender: string                                │ │
│  │  │       ├── interests: string[]                           │ │
│  │  │       ├── status: "searching" | "connected"             │ │
│  │  │       └── joinedAt: timestamp                           │ │
│  │  └── matches/                                              │ │
│  │      └── {userId}/                                         │ │
│  │          ├── partnerId: string                              │ │
│  │          ├── partnerName: string                           │ │
│  │          ├── partnerAvatar: string                          │ │
│  │          ├── chatId: string                                │ │
│  │          └── createdAt: timestamp                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              FIRESTORE                                      │ │
│  │                                                             │ │
│  │  temp_chats/                                                │ │
│  │  └── {chatId}/                                             │ │
│  │      ├── participants: string[]                            │ │
│  │      ├── participantNames: object                          │ │
│  │      ├── participantAvatars: object                         │ │
│  │      ├── isTemporary: boolean                              │ │
│  │      ├── createdAt: timestamp                              │ │
│  │      └── messages/                                          │ │
│  │          └── {messageId}/                                  │ │
│  │              ├── text: string                              │ │
│  │              ├── senderId: string                           │ │
│  │              ├── timestamp: timestamp                       │ │
│  │              └── isRead: boolean                           │ │
│  │                                                             │ │
│  │  direct_messages/                                           │ │
│  │  └── {chatId}/                                             │ │
│  │      ├── participants: string[]                            │ │
│  │      ├── participantNames: object                          │ │
│  │      ├── participantAvatars: object                         │ │
│  │      ├── isTemporary: boolean                              │ │
│  │      ├── savedAt: timestamp                                │ │
│  │      └── messages/                                          │ │
│  │          └── {messageId}/                                  │ │
│  │              ├── text: string                              │ │
│  │              ├── senderId: string                           │ │
│  │              ├── timestamp: timestamp                       │ │
│  │              └── isRead: boolean                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              CLOUD FUNCTIONS                               │ │
│  │                                                             │ │
│  │  findMatches                                                │ │
│  │  ├── Триггер: изменение очереди поиска                     │ │
│  │  ├── Алгоритм совместимости                                │ │
│  │  ├── Создание матчей в RTDB                                │ │
│  │  └── Инициализация чатов в Firestore                       │ │
│  │                                                             │ │
│  │  endMatch                                                   │ │
│  │  ├── Удаление записей матчей                               │ │
│  │  ├── Удаление временных чатов                             │ │
│  │  └── Сброс статусов пользователей                          │ │
│  │                                                             │ │
│  │  saveChat                                                   │ │
│  │  ├── Перенос чата в direct_messages                        │ │
│  │  ├── Копирование сообщений                                 │ │
│  │  └── Удаление временного чата                              │ │
│  │                                                             │ │
│  │  cleanupOldRecords                                         │ │
│  │  ├── Очистка старых записей очереди                        │ │
│  │  └── Запуск по расписанию (каждый час)                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Поток данных

### 1. Поиск собеседника
```
Пользователь → joinSearchQueue() → RTDB queue → Cloud Function findMatches → 
Создание матча → RTDB matches + Firestore temp_chats → Уведомление клиентов
```

### 2. Отправка сообщения
```
Пользователь → sendTempMessage() → Firestore temp_chats/messages → 
Real-time обновление → Отображение у собеседника
```

### 3. Сохранение чата
```
Пользователь → saveChat() → Cloud Function saveChat → 
Перенос в direct_messages → Удаление temp_chats → Уведомление об успехе
```

### 4. Завершение чата
```
Пользователь → endMatch() → Cloud Function endMatch → 
Очистка RTDB matches → Удаление temp_chats → Сброс статусов
```

## Алгоритм совместимости

### Текущая реализация
1. **Возраст**: Разница не более 10 лет
2. **Интересы**: Наличие общих интересов
3. **Статус**: Только пользователи со статусом "searching"

### Возможные улучшения
1. **Геолокация**: Поиск пользователей поблизости
2. **Предпочтения**: Настройки по полу и возрасту
3. **Активность**: Время последней активности
4. **История**: Избегание повторных матчей

## Безопасность

### RTDB Rules
- Пользователи могут читать/писать только свои данные
- Валидация структуры данных при записи

### Firestore Rules
- Доступ только для участников чата
- Валидация отправителей сообщений
- Защита от несанкционированного доступа

## Производительность

### Оптимизации
- Индексы для частых запросов
- Батчевые операции для сообщений
- Очистка старых записей по расписанию

### Масштабирование
- Cloud Functions автоматически масштабируются
- RTDB поддерживает до 200,000 одновременных подключений
- Firestore масштабируется горизонтально

## Мониторинг

### Метрики
- Количество активных пользователей в очереди
- Время поиска матча
- Количество сохраненных чатов
- Ошибки в Cloud Functions

### Логирование
- Firebase Functions Logs
- RTDB Usage Analytics
- Firestore Query Performance

## Развертывание

### Требования
- Firebase проект с включенными RTDB и Firestore
- Firebase CLI для развертывания функций
- Flutter проект с настроенными зависимостями

### Команды
```bash
# Установка зависимостей
cd functions && npm install

# Развертывание функций
firebase deploy --only functions

# Обновление правил
firebase deploy --only firestore:rules,database

# Обновление клиента
flutter pub get
```

## Статус реализации

✅ **Завершено:**
- Архитектура сервиса чат-рулетки
- Структура данных в RTDB для очереди поиска
- Процесс матчинга пользователей
- Система управления чатами (сохранение/удаление)
- Cloud Functions для матчинга и управления чатами
- Интеграция клиентской части с новой архитектурой

🚀 **Готово к использованию:**
- Полная функциональность чат-рулетки
- Real-time обновления
- Безопасность и валидация
- Масштабируемость
